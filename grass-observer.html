<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        html, body {
            overscroll-behavior: none;
            overscroll-behavior-y: none;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overflow-x: hidden !important;
        }

        #container {
            width: 100vw;
            min-height: 100vh;
            overscroll-behavior: none;
            overscroll-behavior-y: none;
        }

        /*html, body {
            overflow: hidden;
        }*/

        /* #container{
            width: 100vw;
            height: 100vh;
            overflow: hidden;        
        }

        .wrapper {
            height: 100vh;
            position: relative;
        }

        section {
            position: relative;
            height: 100vh;
        } */

        .wrapper > .section .video-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .wrapper > .section .video-area > video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .animated-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        .animated-section .outer,
        .animated-section .inner {
            width: 100%;
            height: 100%;
            overflow-y: hidden;
        }

        .animated-section .bg {
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            height: 100%;
            width: 100%;
            top: 0;
            background-size: cover;
            background-position: center;
        }

        /*.wrapper > .section.section-01 { z-index: 2;}
        .wrapper > .section.section-02 { z-index: 2;}
         .wrapper > .section.section-03 { z-index: 1;} */

        .animated-section .txt-area  {
            position: relative;
            z-index: 10;
            color: #fff;
            font-size: 50px;
            font-weight: 700;

            width: 100%;
            height: 100%;
            padding: 100px;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-align: end !important;
            align-items: flex-end !important;
            box-sizing: border-box;
        }

        .wrapper > .section.section-03 {
            position: relative;
            overflow-y: auto; 
            overflow-x: hidden;
            scroll-behavior: smooth;
            background-color: skyblue;
            height: auto !important;
        }

        .wrapper > .section.section-03::-webkit-scrollbar {  width: 3px;  height: 1px;}
        .wrapper > .section.section-03::-webkit-scrollbar-track { background: transparent;}
        .wrapper > .section.section-03::-webkit-scrollbar-thumb {  background: red;}

        .pin-video {
            width: 500px;
            height: 500px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
        }

        .pin-video .video-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .txt-area {
            font-size: 70px;
            color: #fff;
            position: relative;
            z-index: 10;
            padding-bottom: 50vh;
        }

        .txt-area ul li {
            display: -ms-flexbox;
            display: flex;
            -ms-flex-align: center !important;
            align-items: center !important;
        }

        .txt-area ul li span {
            -webkit-flex: 1 1 0%;
            -ms-flex: 1 1 0%;
            flex: 1 1 0%;
            text-align: center;
            padding: 50px 0;
        }

        .txt-area ul li span:nth-child(even) {
            margin-top: 150px;
        }

        .pin-video-area {
            width: 100%;
            height: 100vh;
            position: relative;
            -ms-flex-pack: center !important;
            justify-content: center !important;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-align: center !important;
            align-items: center !important;
            will-change: transform;  /* 성능 최적화 */
            transform: translateZ(0);  /* GPU 레이어 강제 생성 */
            backface-visibility: hidden;  /* 뒤면 숨김으로 성능 향상 */
            position: absolute;
            top: 0;
            left: 50%;
            -webkit-transform: translateX(-50%);
            -ms-transform: translateX(-50%);
            transform: translateX(-50%);
        }

        .section.section-04 {
            height: 50vh !important;
            background-color: pink;           
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="scrollContainer" class="wrapper">
            <section class="section section-01 move-section animated-section">
                <div class="outer">
                    <div class="inner">
                        <div class="bg">
                            <div class="video-area">
                                <video src="./asset/video_main_visual_01.mp4" autoplay muted loop></video>
                            </div>
                            <div class="txt-area">
                                <h2>Section 01</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="section section-02 move-section animated-section">
                <div class="outer">
                    <div class="inner">
                        <div class="bg">
                            <div class="video-area">
                                <video src="./asset/video_main_visual_02.mp4" autoplay muted loop></video>
                            </div>
                            <div class="txt-area">
                                <h2>Section 02</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="section section-03 scroller-section animated-section normal-section">
                <div class="outer">
                    <div class="inner">
                        <div class="pin-video-area">
                            <div class="pin-video">
                                <div class="video-area">
                                    <video src="./asset/video_main_visual_03.mp4" autoplay muted loop></video>
                                </div>
                            </div> 
                        </div>                
                        <article class="txt-area">                        
                            <div class="txt-list">
                                <ul>
                                    <li>
                                        <span>Lorem</span>
                                        <span>ipsum</span>
                                    </li>
                                    <li>
                                        <span>dolor</span>
                                        <span>sit amet</span>
                                    </li>
                                    <li>
                                        <span>consectetur</span>
                                        <span>adipisicing</span>
                                    </li>
                                    <li>                        
                                        <span>elit</span>
                                        <span>Dolorem</span>
                                    </li>
                                    <li>
                                        <span>Lorem</span>
                                        <span>ipsum</span>
                                    </li>
                                    <li>
                                        <span>dolor</span>
                                        <span>sit amet</span>
                                    </li>
                                    <li>
                                        <span>consectetur</span>
                                        <span>adipisicing</span>
                                    </li>
                                    <li>                        
                                        <span>elit</span>
                                        <span>Dolorem</span>
                                    </li>
                                    <li>
                                        <span>Lorem</span>
                                        <span>ipsum</span>
                                    </li>
                                    <li>
                                        <span>dolor</span>
                                        <span>sit amet</span>
                                    </li>
                                    <li>
                                        <span>consectetur</span>
                                        <span>adipisicing</span>
                                    </li>
                                    <li>                        
                                        <span>elit</span>
                                        <span>Dolorem</span>
                                    </li>
                                    <li>
                                        <span>Lorem</span>
                                        <span>ipsum</span>
                                    </li>
                                    <li>
                                        <span>dolor</span>
                                        <span>sit amet</span>
                                    </li>
                                    <li>
                                        <span>consectetur</span>
                                        <span>adipisicing</span>
                                    </li>
                                    <li>                        
                                        <span>elit</span>
                                        <span>Dolorem</span>
                                    </li>
                                    <li>
                                        <span>Lorem</span>
                                        <span>ipsum</span>
                                    </li>
                                    <li>
                                        <span>dolor</span>
                                        <span>sit amet</span>
                                    </li>
                                    <li>
                                        <span>consectetur</span>
                                        <span>adipisicing</span>
                                    </li>
                                    <li>                        
                                        <span>elit</span>
                                        <span>Dolorem</span>
                                    </li>
                                    <li>
                                        <span>consectetur</span>
                                        <span>adipisicing</span>
                                    </li>
                                    <li>                        
                                        <span>elit</span>
                                        <span>Dolorem</span>
                                    </li>
                                    <li>
                                        <span>Lorem</span>
                                        <span>ipsum</span>
                                    </li>
                                    <li>
                                        <span>dolor</span>
                                        <span>sit amet</span>
                                    </li>
                                    <li>
                                        <span>consectetur</span>
                                        <span>adipisicing</span>
                                    </li>
                                    <li>                        
                                        <span>elit</span>
                                        <span>Dolorem</span>
                                    </li>
                                    <li>
                                        <span>Lorem</span>
                                        <span>ipsum</span>
                                    </li>
                                    <li>
                                        <span>dolor</span>
                                        <span>sit amet</span>
                                    </li>
                                    <li>
                                        <span>consectetur</span>
                                        <span>adipisicing</span>
                                    </li>
                                    <li>                        
                                        <span>elit</span>
                                        <span>Dolorem</span>
                                    </li>
                                </ul>
                            </div>
                        </article>  
                    </div>  
                </div>
            </section> 
             
            <section class="section section-04 scroller-section normal-section">
                <div class="inner">
                    Lorem ipsum, dolor sit amet consectetur adipisicing elit. In, odio! Consequuntur nobis modi commodi aut natus veritatis labore provident est! Est obcaecati corrupti dolor, quaerat ducimus animi id accusamus magnam?
                </div>
            </section>
        </div>   
    </div>    
    
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/DrawSVGPlugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/smooth-scrollbar@8.8.4/dist/smooth-scrollbar.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/smoothscroll/1.5.1/SmoothScroll.min.js"></script>
<script>        
    let animatedSections = document.querySelectorAll(".animated-section");
    let scrollContainer = document.getElementById("scrollContainer");
    let normalSections = document.querySelectorAll(".normal-section");
    let allSections = [...animatedSections, ...normalSections];

    let outerWrappers = gsap.utils.toArray(".section .outer");
    let innerWrappers = gsap.utils.toArray(".section .inner");
    let images = gsap.utils.toArray(".section .bg");

    let currentIndex = 0;
    const state = {
        isPlaying : false,
        isSection3 : true,
        mode : "animated",
    }
    let scrollObserver;
    let section3Observer; 
    let section3ScrollHandler;
    let isSection3ScrollTop = false;
    let touchStartY = 0;
    let isTouchMoving = false;
    let smoothEnabled = false;

    function enableSmoothScroll() {
        if (smoothEnabled) return;

        SmoothScroll({
            // animationTime: 800,
            // stepSize: 80,
        });

        smoothEnabled = true;

        console.log('enableSmoothScroll : ', SmoothScroll);
    }

    function disableSmoothScroll() {
        if(SmoothScroll) { 
            SmoothScroll.destroy();   
            smoothEnabled = false;
        }

        console.log('disableSmoothScroll : ', SmoothScroll);
    }

    // html, body 스타일 제어 함수
    function updateBodyScrollStyle(index) {
        const html = document.documentElement;
        const body = document.body;

        console.log('updateBodyScrollStyle : ', index);
        
        if (index < 2) {
            // 섹션 0, 1일 때: 100vh 고정, overflow hidden
            gsap.set([html, body], {
                height: '100vh',
                overflow: 'hidden',
                //position: 'fixed',
                //width: '100%',
                ///top: 0,
                //left: 0
            });
        } else {
            // 섹션 2 이상일 때: 스크롤 가능하도록 원래대로
            gsap.set([html, body], {
                height: 'auto',
                overflow: 'auto',
                overflowY: 'auto',
                //position: 'static',
                //width: 'auto',
                //top: 'auto',
                //left: 'auto'
            });
            
            // 섹션 2로 전환 시 스크롤 위치를 0으로 설정
            requestAnimationFrame(() => {
                window.scrollTo(0, 0);
            });
        }
    }

    // 모바일 터치 이벤트로 인한 pull-to-refresh 방지
    document.addEventListener('touchstart', function(e) {
        touchStartY = e.touches[0].clientY;
        isTouchMoving = false;
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
        if (!isTouchMoving) {
            isTouchMoving = true;
        }
        
        const touchY = e.touches[0].clientY;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        
        // 페이지 최상단에서 아래로 드래그하는 경우 preventDefault
        if (scrollTop === 0 && touchY > touchStartY) {
            e.preventDefault();
            return false;
        }
        
        // 페이지 최하단에서 위로 드래그하는 경우도 방지 (필요시)
        const scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
        const clientHeight = window.innerHeight || document.documentElement.clientHeight;
        if (scrollTop + clientHeight >= scrollHeight && touchY < touchStartY) {
            e.preventDefault();
            return false;
        }
    }, { passive: false });

    document.addEventListener('touchend', function(e) {
        isTouchMoving = false;
    }, { passive: true });

    window.addEventListener('scroll', (e) => {
        if (window.scrollY === 0 && currentIndex == 2) { 
            isSection3ScrollTop = true;

            if(!section3Observer.isEnabled) {
                section3Observer.enable();
                disableSmoothScroll();
                isSection3ScrollTop = false;
            }
        } 
    })

    ScrollTrigger.create({
        trigger: '.pin-video-area',
        start: 'top top',
        end: 'bottom bottom',
        endTrigger: '.section-03',
        pin: true,
        pinSpacing: false,
        //pinType: "transform",  // transform 대신 fixed 사용
        //anticipatePin: 0,  // anticipatePin을 0으로 설정
        //invalidateOnRefresh: true,
        //refreshPriority: -1,  // 우선순위 낮춤
        //markers: true,
        id: 'pin-video-area',
        //markers: true,
    });

    const txts = document.querySelectorAll('.txt-area ul li span');
    txts.forEach(txt => {
        gsap.set(txt, { autoAlpha: 0 })

        const txtAnimation = gsap.fromTo(txt, {
            autoAlpha: 0
        }, {
            autoAlpha: 1,
            duration: 1,
            ease: 'power1.inOut'
        });

        ScrollTrigger.create({
            trigger: txt,
            start: 'top center',
            end: 'bottom center',
            scrub: true,
            animation: txtAnimation,
            //markers: true,
            onLeave: () => {
                gsap.set(txt, { autoAlpha: 0 })
            }
        });
    });

    function addSection3ScrollListener() {
        section3Observer = Observer.create({
            target: window,
            type: "wheel,touch,pointer",
            wheelSpeed: -1,
            touchSpeed: -1,
            onUp: () => {
                //console.log('section3Observer onUp 1111');
                if (!isSection3ScrollTop) {
                    section3Observer.disable();
                    enableSmoothScroll();
                }
            },
            onDown: () => {
                //console.log('section3Observer onDown 1111');

                if (window.scrollY === 0) {
                    //console.log('section3Observer onUp 2222');
                    if (!state.isPlaying && state.mode === "scroll") {
                        scrollObserver.enable();
                        state.mode = "animated";
                        state.isSection3 = false;

                        if(currentIndex == 2) {
                            section3Observer.disable();
                            disableSmoothScroll();
                            gotoSection(currentIndex - 1, -1);
                        }
                    }
                } else {
                    section3Observer.disable();
                    enableSmoothScroll();
                }
            },
            tolerance: 10,
            preventDefault: function() {
                return window.scrollY === 0;
            }
        });
    }

    function removeSection3ScrollListener() {
        if (section3Observer) {
            section3Observer.kill();
            section3Observer = null;
        }
    }

    // const pages = {
    //     page01:{
    //         enter:()=>{
    //             console.log('enter page01');
    //         },
    //         leave:()=>{
    //             console.log('leave page01');
    //         },
    //     },
    //     page02:{
    //         enter:()=>{
    //             console.log('enter page02');
    //         },
    //         leave:()=>{
    //             console.log('leave page02');
    //         }
    //     },
    //     page03:{
    //         enter:()=>{
    //             console.log('enter page03');
    //             state.isSection3 = true;
    //         },
    //         leave:()=>{
    //             console.log('leave page03');
    //         }
    //     },
    // }

    // function globalEnter(){
    //     console.log('globalEnter');
    // }

    // function globalLeave(){
    //     console.log('globalLeave');
    // }

    function setZIndex(index){
        gsap.set(animatedSections, { zIndex: 0 });
        gsap.set(animatedSections[index], { zIndex: 3 });
        tl.set([outerWrappers[index], innerWrappers[index]], { yPercent: 0 })
    }

    let tl = gsap.timeline();
    // tl.set(outerWrappers, { yPercent: 100 });
    // tl.set(innerWrappers, { yPercent: -100 });

    function gotoSection(index, direction) {
        if (state.isPlaying || index === currentIndex) return;
        if (index < 0 || index >= allSections.length) return;
        
        state.isPlaying = true;

        let fromTop = direction === -1;
        let dFactor = fromTop ? -1 : 1; // 1 아래로, -1 위로

        // 애니메이션 모드로 돌아가기
        // 스크롤에서 섹션 1 또는 2로 이동
        if (index < 3 && state.mode === "scroll") {
            state.mode = "animated";
            scrollObserver.enable();

            removeSection3ScrollListener();
            updateBodyScrollStyle(index); // 스타일 업데이트
        }

        // 표준 애니메이션 섹션 전환
        if (index < 3) { 
            let tl = gsap.timeline({
                defaults: { duration: 1.25, ease: "power1.inOut" },
                onComplete: () => {
                    state.isPlaying = false;
                    currentIndex = index;
                    updateBodyScrollStyle(currentIndex); // 스타일 업데이트
                }
            });

            if( !fromTop) {
                gsap.set(animatedSections[index], { autoAlpha: 1, zIndex: 2 });
                gsap.set(animatedSections[currentIndex], { zIndex: 3 });
            } else {
                gsap.set(animatedSections[currentIndex], { autoAlpha: 1, zIndex: 2 });
                gsap.set(animatedSections[index], { autoAlpha: 1, zIndex: 3 });
            }
            
            let animationTarget = fromTop ? animatedSections[index] : animatedSections[currentIndex];
            let hideTarget = fromTop ? animatedSections[currentIndex] : animatedSections[index];

            tl.fromTo(animationTarget, {
                clipPath: fromTop ?  `inset(0 0 100% 0)` : `inset(0 0 0% 0)`,
            }, {
                clipPath: fromTop ?  `inset(0 0 0% 0)` : `inset(0 0 100% 0)`,
                onComplete: () => {
                    gsap.set(animatedSections[currentIndex], { 
                        //autoAlpha: 0,
                        zIndex: 1,
                    });                   
                }
            },)
            
        }
    }

    /*
    function addSection3ScrollListener() {
        section3ScrollHandler = function(e) {
            if (window.scrollY === 0) {
                if (e.deltaY < 0) {                    
                    if (!state.isPlaying && state.mode === "scroll") {
                        scrollObserver.enable();
                        state.mode = "animated";
                        state.isSection3 = false;

                        if(currentIndex == 2) gotoSection(currentIndex - 1, -1);
                    }
                }
            }
        };
        
        window.addEventListener('wheel', section3ScrollHandler, { passive: false });
    }
    */
        

    scrollObserver = Observer.create({
        target: window,
        type: "wheel,touch,pointer",
        wheelSpeed: -1,
        touchSpeed: -1,
        preventDefault: function() {
            // 모바일에서 페이지 최상단일 때만 preventDefault
            if (window.scrollY === 0) {
                return true;
            }
            return state.mode === "animated";
        },
        onDown: () => {
            if (!state.isPlaying && state.mode === "animated") {
                //console.log('1. currentIndex : ', currentIndex);

                // (1) currentIndex == 2 // 2-> 1
                // (2) currentIndex == 1 // 1-> 0   
                if (currentIndex > 0) {
                    gotoSection(currentIndex - 1, -1);
                } 
            }
        },
        onUp: () => {
            if (!state.isPlaying) {
                if (state.mode === "animated") {
                    //console.log('2. currentIndex : ', currentIndex);

                    // (1) currentIndex = 0  // 0 -> 1
                    // (2) currentIndex = 1 // 1 -> 2
                    if(currentIndex < 2) {
                        gotoSection(currentIndex + 1, 1);
                    } else {
                        if (currentIndex >= 2 && state.mode === "animated") {
                            state.mode = "scroll";
                            scrollObserver.disable();

                            //addSection3ScrollListener();
                            addSection3ScrollListener();
                            updateBodyScrollStyle(2); // 섹션 2로 전환 시 스크롤 가능하도록

                            return;
                        }
                    }
                }
            }
        },
        tolerance: 10,
        touchInertia: false,
    });

    setZIndex(0);
    disableSmoothScroll();
    updateBodyScrollStyle(0); // 초기 상태 설정

</script>
</html>
